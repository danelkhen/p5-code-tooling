#!/usr/bin/env perl

use strict;
use warnings;

use Test::More;

BEGIN {
    use_ok('Source::Tooling::Perl::Stats::File');
    use_ok('Source::Tooling::Perl::Stats::Package');
    use_ok('Source::Tooling::Perl::Stats::Sub');
    use_ok('Source::Tooling::Perl::Stats::Var');
}

subtest '... basic package test' => sub {

    my $src = q[
        package Foo;

        package Bar;

        package Foo::Bar;

        1;
    ];

    my $f = Source::Tooling::Perl::Stats::File->new( \$src );

    is_deeply(
        [qw[ Foo Bar Foo::Bar ]],
        [ map { $_->name } $f->packages ],
        '... got the packages we expected'
    );

    is_deeply(
        [ 1, 1, 1 ],
        [ map { $_->line_count } $f->packages ],
        '... got the package line counts we expected'
    );
};

subtest '... basic sub test' => sub {

    my $src = q[
            sub foo { $_[0] * 10 }
            sub bar {
                my $x = 0 .. 100;
                $x += 2;
                return $x;
            }
            package Foo {
                sub baz {
                    $_[0]->{wtf}
                }
            }
        1;
    ];

    my $f = Source::Tooling::Perl::Stats::File->new( \$src );

    is_deeply(
        [qw[ foo bar ]],
        [ map { $_->name } $f->subs ],
        '... got the subs we expected'
    );

    is_deeply(
        [ 1, 5 ],
        [ map { $_->line_count } $f->subs ],
        '... got the sub line counts we expected'
    );

    subtest '... test the Foo package' => sub {
        my ($Foo) = $f->packages;

        is($Foo->name, 'Foo', '... got the expected name');
        is($Foo->line_count, 6, '... got the expected line count');

        is_deeply(
            [qw[ baz ]],
            [ map { $_->name } $Foo->subs ],
            '... got the subs we expected'
        );

        is_deeply(
            [ 3 ],
            [ map { $_->line_count } $Foo->subs ],
            '... got the sub line counts we expected'
        );
    };
};

subtest '... basic variable test' => sub {

    my $src = q[
            our $FOO = 10;
            our ($BAR, @BAZ) = (20, 30);
            package Foo {
                our $BAR = 20;
                $Foo::BAZ = 30; # not a declaration
            }
        1;
    ];

    my $f = Source::Tooling::Perl::Stats::File->new( \$src );

    is_deeply(
        [qw[ $FOO $BAR @BAZ ]],
        [ map { $_->name } $f->vars ],
        '... got the vars we expected'
    );

    is_deeply(
        [ 1, 1, 1 ],
        [ map { $_->line_count } $f->vars ],
        '... got the sub line counts we expected'
    );

    subtest '... test the Foo package' => sub {
        my ($Foo) = $f->packages;

        is($Foo->name, 'Foo', '... got the expected name');
        is($Foo->line_count, 5, '... got the expected line count');

        is_deeply(
            [qw[ $BAR ]],
            [ map { $_->name } $Foo->vars ],
            '... got the vars we expected'
        );

        is_deeply(
            [ 1 ],
            [ map { $_->line_count } $Foo->vars ],
            '... got the var line counts we expected'
        );
    };

};


done_testing;
